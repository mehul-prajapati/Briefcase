<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" dir="ltr" lang="en"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>
    Counting Semaphores, Binary Semaphores and Mutexes explained    [ChibiOS/RT free embedded RTOS]
  </title>

  <meta name="generator" content="DokuWiki">
<meta name="robots" content="index,follow">
<meta name="date" content="2012-06-05T19:49:27+0200">
<meta name="keywords" content="chibios,articles,semaphores_mutexes">
<link rel="search" type="application/opensearchdescription+xml" href="http://www.chibios.org/dokuwiki/lib/exe/opensearch.php" title="ChibiOS/RT free embedded RTOS">
<link rel="start" href="http://www.chibios.org/dokuwiki/">
<link rel="contents" href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:articles:semaphores_mutexes&amp;do=index" title="Sitemap">
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="http://www.chibios.org/dokuwiki/feed.php">
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="http://www.chibios.org/dokuwiki/feed.php?mode=list&amp;ns=chibios:articles">
<link rel="alternate" type="text/html" title="Plain HTML" href="http://www.chibios.org/dokuwiki/doku.php?do=export_xhtml&amp;id=chibios:articles:semaphores_mutexes">
<link rel="canonical" href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:articles:semaphores_mutexes">
<link rel="stylesheet" media="screen" type="text/css" href="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/css_002.css">
<link rel="stylesheet" media="all" type="text/css" href="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/css_003.css">
<link rel="stylesheet" media="print" type="text/css" href="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/css.css">
<script src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/ga.js" async="" type="text/javascript"></script><script async="" src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/cbgapi.loaded_1"></script><script async="" src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/cbgapi.loaded_0"></script><script gapi_processed="true" src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/plusone.js" async="" type="text/javascript"></script><script type="text/javascript"><!--//--><![CDATA[//><!--
var NS='chibios:articles';var JSINFO = {"id":"chibios:articles:semaphores_mutexes","namespace":"chibios:articles"};
//--><!]]></script>
<script type="text/javascript" charset="utf-8" src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/js.php"></script>

  <link rel="shortcut icon" href="http://www.chibios.org/dokuwiki/lib/tpl/default/images/favicon.ico">

  <script src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/131.js" async="" id="_12mblejs" type="text/javascript"></script><script src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/mle.js" id="_12mlejs" type="text/javascript"></script></head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:articles:semaphores_mutexes&amp;do=backlink" title="Backlinks">Counting Semaphores, Binary Semaphores and Mutexes explained</a>]]
      </div>
      <div class="logo">
        <a href="http://www.chibios.org/dokuwiki/doku.php" name="dokuwiki__top" id="dokuwiki__top" accesskey="h" title="[H]">ChibiOS/RT free embedded RTOS</a>      </div>

      <div class="clearer"></div>
    </div>

    
    <div class="bar" id="bar__top">
      <div class="bar-left" id="bar__topleft">
                <form class="button btn_revs" method="get" action="/dokuwiki/doku.php"><div class="no"><input name="do" value="revisions" type="hidden"><input name="id" value="chibios:articles:semaphores_mutexes" type="hidden"><input value="Old revisions" class="button" accesskey="o" title="Old revisions [O]" type="submit"></div></form>      </div>

      <div class="bar-right" id="bar__topright">
        <form class="button btn_recent" method="get" action="/dokuwiki/doku.php"><div class="no"><input name="do" value="recent" type="hidden"><input name="id" value="chibios:articles:semaphores_mutexes" type="hidden"><input value="Recent changes" class="button" accesskey="r" title="Recent changes [R]" type="submit"></div></form>        <form action="/dokuwiki/doku.php" accept-charset="utf-8" class="search" id="dw__search" method="get"><div class="no"><input name="do" value="search" type="hidden"><input id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" type="text"><input value="Search" class="button" title="Search" type="submit"><div style="display: none;" id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>&nbsp;
      </div>

      <div class="clearer"></div>
    </div>

        <div class="breadcrumbs">
      <span class="bchead">Trace:</span> <span class="bcsep">»</span> <span class="curid"><a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:articles:semaphores_mutexes" class="breadcrumbs" title="chibios:articles:semaphores_mutexes">Counting Semaphores, Binary Semaphores and Mutexes explained</a></span>          </div>
    
    
  </div>
  
<p align="center"><br>
<script type="text/javascript"><!--
google_ad_client = "pub-3840594581853944";
/* Main pages, bottom, 728x90, created 9/18/10 */
google_ad_slot = "5653904444";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript" src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/show_ads.js">
</script><ins style="display:inline-table;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent"><ins id="aswift_0_anchor" style="display:block;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_0" name="aswift_0" style="left:0;position:absolute;top:0;" width="728" frameborder="0" height="90" scrolling="no"></iframe></ins></ins>
</p>

  
  <div class="page">
    <!-- wikipage start -->
    <div class="left_sidebar">
<div class="main_sidebar sidebar_box">

<h1 class="sectionedit6"><a name="sb_left_navigation" id="sb_left_navigation">Navigation</a></h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=start" class="wikilink1" title="start">Homepage</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=news" class="wikilink1" title="news">What's new</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:matrix" class="wikilink1" title="chibios:matrix">Features Matrix</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:architectures" class="wikilink1" title="chibios:architectures">Supported Architectures</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:documents" class="wikilink1" title="chibios:documents">Documentation and Guides</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:metrics" class="wikilink1" title="chibios:metrics">Performance and Testing Data</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:copyright" class="wikilink1" title="chibios:copyright">Copyright</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:license" class="wikilink1" title="chibios:license">Licensing Options</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:download" class="wikilink1" title="chibios:download">Downloads</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:support" class="wikilink1" title="chibios:support">Support Options</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:community" class="wikilink1" title="chibios:community">Community Projects</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:links" class="wikilink1" title="chibios:links">Links</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:contacts" class="wikilink1" title="chibios:contacts">Contact Us</a></div>
</li>
</ul>

<p>

<strong>Related Projects</strong>
</p>
<ul>
<li class="level1"><div class="li"> <a href="http://forum.chibios.org/phpbb/viewforum.php?f=12/" class="urlextern" title="http://forum.chibios.org/phpbb/viewforum.php?f=12/">NilRTOS</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://ugfx.org/" class="urlextern" title="http://ugfx.org">µGFX</a></div>
</li>
</ul>

<p>

<strong>External links</strong>
</p>
<ul>
<li class="level1"><div class="li"> <a href="http://forum.chibios.org/" class="urlextern" title="http://forum.chibios.org">Discussion Forum</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://sourceforge.net/projects/chibios/" class="urlextern" title="http://sourceforge.net/projects/chibios/">SourceForge project page</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.ohloh.net/p/chibios" class="urlextern" title="http://www.ohloh.net/p/chibios">Code Metrics</a> on ohloh.net</div>
</li>
</ul>
<hr>

<br>
<p align="center">
<script type="text/javascript"><!--
google_ad_client = "pub-3840594581853944";
/* 200x200, created 10/9/10 */
google_ad_slot = "6448204779";
google_ad_width = 200;
google_ad_height = 200;
//-->
</script>
<script type="text/javascript" src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/show_ads.js">
</script><ins style="display:inline-table;border:none;height:200px;margin:0;padding:0;position:relative;visibility:visible;width:200px;background-color:transparent"><ins id="aswift_1_anchor" style="display:block;border:none;height:200px;margin:0;padding:0;position:relative;visibility:visible;width:200px;background-color:transparent"><iframe marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" onload="var i=this.id,s=window.google_iframe_oncopy,H=s&amp;&amp;s.handlers,h=H&amp;&amp;H[i],w=this.contentWindow,d;try{d=w.document}catch(e){}if(h&amp;&amp;d&amp;&amp;(!d.body||!d.body.firstChild)){if(h.call){setTimeout(h,0)}else if(h.match){try{h=s.upd(h,i)}catch(e){}w.location.replace(h)}}" id="aswift_1" name="aswift_1" style="left:0;position:absolute;top:0;" width="200" frameborder="0" height="200" scrolling="no"></iframe></ins></ins>
</p>
<hr>

<p align="center">
  <br>
  <a href="http://sourceforge.net/donate/index.php?group_id=205897">
    <img src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/project-support.jpg" alt="Support This Project" width="94" height="32" align="middle" border="0">
  </a>
  <br><br>
  <!-- Inizio Codice Shinystat -->
  <script type="text/javascript" language="JavaScript" src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/getcod.js">
  </script><a href="http://s5.shinystat.com/cgi-bin/shinystatv.cgi?USER=ChibiOS&amp;NH=1&amp;NHF=1" target="_new"><img src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/shinystat.png" border="0"></a>
  <noscript><a href="http://www.shinystat.com/it" target="_top">
  <img src="http://www.shinystat.com/cgi-bin/shinystat.cgi?USER=ChibiOS"
       alt="Statistiche" border="0">
  </a></noscript>
  <!-- Fine Codice Shinystat -->
</p>

</div>

</div>
</div>
<div class="page_right">
<!-- TOC START -->
<div class="toc">
<div style="cursor: pointer;" class="tocheader toctoggle" id="toc__header"><span class="toc_close" style="cursor: pointer;" id="toc__toggle"><span>−</span></span>Table of Contents</div>
<div id="toc__inside">

<ul class="toc">
<li class="level1"><div class="li"><span class="li"><a href="#counting_semaphores_binary_semaphores_and_mutexes_explained" class="toc">Counting Semaphores, Binary Semaphores and Mutexes explained</a></span></div>
<ul class="toc">
<li class="level2"><div class="li"><span class="li"><a href="#introduction" class="toc">Introduction</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#binary_semaphores" class="toc">Binary Semaphores</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#counting_semaphores" class="toc">Counting Semaphores</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#mutexes" class="toc">Mutexes</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#comparison_matrix" class="toc">Comparison matrix</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#notes_regarding_chibios_rt" class="toc">Notes regarding ChibiOS/RT</a></span></div></li></ul>
</li></ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1"><a name="counting_semaphores_binary_semaphores_and_mutexes_explained" id="counting_semaphores_binary_semaphores_and_mutexes_explained">Counting Semaphores, Binary Semaphores and Mutexes explained</a></h1>
<div class="level1">

<table>
<tbody><tr>
<td>

<p>
ChibiOS/RT, like other RTOSs, implements multiple synchronization 
primitives. Some primitives may appear similar and this can generate 
confusion when deciding which primitive is best suited for a given 
scenario.
</p>

</td>
<td>
<!-- Place this tag where you want the +1 button to render -->
<div align="right">
<div id="___plusone_0" style="text-indent: 0px; margin: 0px; padding: 0px; background: none repeat scroll 0% 0% transparent; border-style: none; float: none; line-height: normal; font-size: 1px; vertical-align: baseline; display: inline-block; width: 50px; height: 60px;"><iframe title="+1" data-gapiattached="true" src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/fastbutton.html" name="I0_1389250835604" id="I0_1389250835604" vspace="0" tabindex="0" style="position: static; top: 0px; width: 50px; margin: 0px; border-style: none; left: 0px; visibility: visible; height: 60px;" marginwidth="0" marginheight="0" hspace="0" width="100%" frameborder="0" scrolling="no"></iframe></div>
</div>
</td>
</tr>
</tbody></table>

<!-- Place this tag after the last plusone tag -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

</div>

<h2 class="sectionedit2"><a name="introduction" id="introduction">Introduction</a></h2>
<div class="level2">

<p>

We will consider three synchronization mechanisms implemented in ChibiOS/RT:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Binary Semaphores</strong>.</div>
</li>
<li class="level1"><div class="li"> <strong>Counting Semaphores</strong>.</div>
</li>
<li class="level1"><div class="li"> <strong>Mutexes</strong>.</div>
</li>
</ul>

<p>

Note that other RTOSs may have implementation differences or even name 
them in a different way, there is not a standard about both terminology 
and exact behavior. Often the binary semaphore term is used as a synonym
 of mutex, this is not the case in ChibiOS/RT, there are fundamental 
differences as we will see.
</p>

</div>

<h2 class="sectionedit3"><a name="binary_semaphores" id="binary_semaphores">Binary Semaphores</a></h2>
<div class="level2">

<p>

A binary semaphore is a synchronization object that can have only two states:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Not taken</strong>.</div>
</li>
<li class="level1"><div class="li"> <strong>Taken</strong>.</div>
</li>
</ul>

<p>

Two operations are defined:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Take</strong> (<code>chBSemWait()</code>
 in ChibiOS/RT). Taking a binary semaphore brings it in the “taken” 
state, trying to take a semaphore that is already taken enters the 
invoking thread into a waiting queue.</div>
</li>
<li class="level1"><div class="li"> <strong>Release</strong> (<code>chBSemSignal()</code>
 in ChibiOS/RT). Releasing a binary semaphore brings it in the “not 
taken” state if there are not queued threads. If there are queued 
threads then a thread is removed from the queue and resumed, the binary 
semaphore remains in the “taken” state. Releasing a semaphore that is 
already in its “not taken” state has no effect.</div>
</li>
</ul>

<p>

<a href="http://www.chibios.org/dokuwiki/lib/exe/detail.php?id=chibios%3Aarticles%3Asemaphores_mutexes&amp;media=chibios:articles:bsem.png" class="media" title="chibios:articles:bsem.png"><img src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/fetch.png" class="mediacenter" title="Binary Semaphores states diagram" alt="Binary Semaphores states diagram"></a>
</p>

<p>
Binary semaphores have no ownership attribute and can be released by any
 thread or interrupt handler regardless of who performed the last take 
operation. Because of this binary semaphores are often used to 
synchronize threads with external events implemented as ISRs, for 
example waiting for a packet from a network or waiting that a button is 
pressed.
</p>

<p>
Because there is no ownership concept a binary semaphore object can be 
created to be either in the “taken” or “not taken” state initially.
</p>

</div>

<h2 class="sectionedit4"><a name="counting_semaphores" id="counting_semaphores">Counting Semaphores</a></h2>
<div class="level2">

<p>

A counting semaphore is a synchronization object that can have an 
arbitrarily large number of states. The internal state is defined by a 
signed integer variable, the counter.
The counter value (N) has a precise meaning:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Negative</strong>, there are exactly -N threads queued on the semaphore.</div>
</li>
<li class="level1"><div class="li"> <strong>Zero</strong>, no waiting threads, a wait operation would put in queue the invoking thread.</div>
</li>
<li class="level1"><div class="li"> <strong>Positive</strong>, no waiting threads, a wait operation would not put in queue the invoking thread.</div>
</li>
</ul>

<p>

Two operations are defined for counting semaphores:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Wait</strong> (<code>chSemWait()</code> in ChibiOS/RT). This operation decreases the semaphore counter, if the result is negative then the invoking thread is queued.</div>
</li>
<li class="level1"><div class="li"> <strong>Signal</strong>  (<code>chSemSignal()</code>
 in ChibiOS/RT). This operation increases the semaphore counter, if the 
result is non-negative then a waiting thread is removed from the queue 
and resumed.</div>
</li>
</ul>

<p>

<a href="http://www.chibios.org/dokuwiki/lib/exe/detail.php?id=chibios%3Aarticles%3Asemaphores_mutexes&amp;media=chibios:articles:csem.png" class="media" title="chibios:articles:csem.png"><img src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/fetch_003.png" class="mediacenter" title="Counting Semaphores states diagram" alt="Counting Semaphores states diagram"></a>
</p>

<p>
Counting semaphores have no ownership attribute and can be signaled by 
any thread or interrupt handler regardless of who performed the last 
wait operation.
</p>

<p>
Because there is no ownership concept a counting semaphore object can be
 created with any initial counter value as long it is non-negative.
</p>

<p>
The counting semaphores are usually used as guards of resources 
available in a discrete quantity. For example the counter may represent 
the number of used slots into a circular queue, producer threads would 
“signal” the semaphores when inserting items in the queue, consumer 
threads would “wait” for an item to appear in queue, this would ensure 
that no consumer would be able to fetch an item from the queue if there 
are no items available. Note that this is exactly how I/O queues are 
implemented in ChibiOS/RT, very convenient.
</p>

</div>

<h2 class="sectionedit5"><a name="mutexes" id="mutexes">Mutexes</a></h2>
<div class="level2">

<p>

A mutex is a synchronization object that can have only two states:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Not owned</strong>.</div>
</li>
<li class="level1"><div class="li"> <strong>Owned</strong>.</div>
</li>
</ul>

<p>

Two operations are defined for mutexes:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Lock</strong> (<code>chMtxLock()</code>
 in ChibiOS/RT). This operation attempts to take ownership of a mutex, 
if the mutex is already owned by another thread then the invoking thread
 is queued.</div>
</li>
<li class="level1"><div class="li"> <strong>Unlock</strong>  (<code>chMtxUnlock()</code>
 in ChibiOS/RT). This operation relinquishes ownership of a mutex. If 
there are queued threads then a thread is removed from the queue and 
resumed, ownership is implicitly assigned to the thread.</div>
</li>
</ul>

<p>

<a href="http://www.chibios.org/dokuwiki/lib/exe/detail.php?id=chibios%3Aarticles%3Asemaphores_mutexes&amp;media=chibios:articles:mutex.png" class="media" title="chibios:articles:mutex.png"><img src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/fetch_002.png" class="mediacenter" title="Mutexes states diagram" alt="Mutexes states diagram"></a>
</p>

<p>
Note that, unlike semaphores, mutexes do have owners. A mutex can be 
unlocked only by the thread that owns it, this precludes the use of 
mutexes from interrupt handles but enables the implementation of the 
Priority Inheritance protocol, most RTOSs implement this protocol in 
order to address the Priority Inversion problem. It must be said that 
few RTOSs implement this protocol fully (any number of threads and 
mutexes involved) and even less do that efficiently.
</p>

<p>
Mutexes have one single use, Mutual Exclusion, and are optimized for 
that. Semaphores can also handle mutual exclusion scenarios but are best
 used as a communication mechanism between threads or between ISRs and 
threads. Also see the following articles:
</p>
<ul>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:guides:mutual_exclusion_guide" class="wikilink1" title="chibios:guides:mutual_exclusion_guide">ChibiOS/RT mutual exclusion guide</a>.</div>
</li>
<li class="level1"><div class="li"> <a href="http://www.chibios.org/dokuwiki/doku.php?id=chibios:howtos:wakeup" class="wikilink1" title="chibios:howtos:wakeup">How to wake up a thread from an interrupt handler</a>.</div>
</li>
</ul>

</div>

<h2 class="sectionedit6"><a name="comparison_matrix" id="comparison_matrix">Comparison matrix</a></h2>
<div class="level2">

<p>

Features summary:

</p>
<div class="table sectionedit7"><table class="inline">
	<tbody><tr class="row0">
		<th class="col0 centeralign">  Feature            </th><th class="col1 centeralign">  Binary Semaphores         </th><th class="col2 rightalign">  Counter Semaphores </th><th class="col3 centeralign">  Mutexes   </th>
	</tr>
	<tr class="row1">
		<td class="col0 leftalign">Internal states      </td><td class="col1 centeralign">  2                         </td><td class="col2 centeralign">  N                  </td><td class="col3 centeralign">  2         </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign">Use from ISRs        </td><td class="col1 centeralign">  yes                       </td><td class="col2 centeralign">  yes                </td><td class="col3 centeralign">  no        </td>
	</tr>
	<tr class="row3">
		<td class="col0 leftalign">Ownership            </td><td class="col1 centeralign">  no                        </td><td class="col2 centeralign">  no                 </td><td class="col3 centeralign">  yes       </td>
	</tr>
	<tr class="row4">
		<td class="col0">Priority Inheritance </td><td class="col1 centeralign">  no*1                      </td><td class="col2 centeralign">  no*1               </td><td class="col3 centeralign">  yes*2     </td>
	</tr>
	<tr class="row5">
		<td class="col0 leftalign">Initialization       </td><td class="col1 rightalign">  either taken or not taken </td><td class="col2 centeralign">  counter &gt;= 0       </td><td class="col3 rightalign">  always not owned </td>
	</tr>
	<tr class="row6">
		<td class="col0">Queue organization*3 </td><td class="col1 centeralign">  FIFO or priority          </td><td class="col2 centeralign">  FIFO or priority   </td><td class="col3 centeralign">  Priority  </td>
	</tr>
</tbody></table></div>
<ol>
<li class="level1"><div class="li"> In ChibiOS/RT if the option <code>CH_USE_SEMAPHORES_PRIORITY</code> is enabled then the semaphores queues are subject to reordering because priority inheritance triggered by a mutex operation.</div>
</li>
<li class="level1"><div class="li"> If implemented, ChibiOS/RT implements the Priority Inheritance protocol for any number of threads and mutexes.</div>
</li>
<li class="level1"><div class="li"> As implemented in ChibiOS/RT.</div>
</li>
</ol>

</div>

<h2 class="sectionedit8"><a name="notes_regarding_chibios_rt" id="notes_regarding_chibios_rt">Notes regarding ChibiOS/RT</a></h2>
<div class="level2">

<p>

ChibiOS/RT extends the above mechanisms in several ways:
</p>
<ul>
<li class="level1"><div class="li"> Both binary and counting semaphores 
have a “timeout” variant of the “wait” operation. This allows to 
terminate the wait if a semaphore is not signaled within a finite time. 
The timeout feature is especially useful when semaphores are used as an 
I/O synchronization primitive, most communication protocols require 
timeout handling.</div>
</li>
<li class="level1"><div class="li"> Both binary and counting semaphores 
implement a “reset” operation that empties the waiting queue, all the 
waiting threads are resumed and the semaphore is reset to a known state.</div>
</li>
<li class="level1"><div class="li"> Semaphore's “wait” operation returns an encoded message that allows to understand what happened:</div>
<ul>
<li class="level2"><div class="li"> <code>RDY_OK</code>, normal exit from a wait.</div>
</li>
<li class="level2"><div class="li"> <code>RDY_RESET</code>, the semaphore has been reset while waiting.</div>
</li>
<li class="level2"><div class="li"> <code>RDY_TIMEOUT</code>, timeout occurred while waiting.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> The “unlock” operation on mutexes 
takes no parameters, ChibiOS/RT always unlocks caller's most recently 
locked mutex for efficiency and safe operations.</div>
</li>
<li class="level1"><div class="li"> Mutexes implement also an “unlock all” operation that efficiently releases all the mutexes owned by the invoking thread.</div>
</li>
<li class="level1"><div class="li"> Mutexes implement also an “try lock”
 operation that tries to lock a mutex but does not wait if the mutex is 
already owned by another thread.</div>
</li>
<li class="level1"><div class="li"> Trying to lock a mutex that is already owned is a forbidden operation.</div>
</li>
</ul>

</div>

</div>
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        chibios/articles/semaphores_mutexes.txt · Last modified: 2012/06/05 19:49 by giovanni      </div>
    </div>

   
    <div class="bar" id="bar__bottom">
      <div class="bar-left" id="bar__bottomleft">
                <form class="button btn_revs" method="get" action="/dokuwiki/doku.php"><div class="no"><input name="do" value="revisions" type="hidden"><input name="id" value="chibios:articles:semaphores_mutexes" type="hidden"><input value="Old revisions" class="button" accesskey="o" title="Old revisions [O]" type="submit"></div></form>              </div>
      <div class="bar-right" id="bar__bottomright">
                                <form class="button btn_login" method="get" action="/dokuwiki/doku.php"><div class="no"><input name="do" value="login" type="hidden"><input name="sectok" value="b6e4eff6b20cdbaf305b1d72a5bfc137" type="hidden"><input name="id" value="chibios:articles:semaphores_mutexes" type="hidden"><input value="Login" class="button" title="Login" type="submit"></div></form>        <form class="button btn_index" method="get" action="/dokuwiki/doku.php"><div class="no"><input name="do" value="index" type="hidden"><input name="id" value="chibios:articles:semaphores_mutexes" type="hidden"><input value="Sitemap" class="button" accesskey="x" title="Sitemap [X]" type="submit"></div></form>        <a class="nolink" href="#dokuwiki__top"><input class="button" value="Back to top" onclick="window.scrollTo(0, 0)" title="Back to top" type="button"></a>&nbsp;
      </div>
      <div class="clearer"></div>
    </div>

  </div>

  <div class="license">Except where otherwise noted, content on this wiki is licensed under the following license:<a href="http://www.gnu.org/licenses/fdl-1.3.html" rel="license" class="urlextern">GNU Free Documentation License 1.3</a></div>
</div><iframe style="width: 1px; height: 1px; position: absolute; top: -100px;" src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/postmessageRelay.html" id="oauth2relay1333562416" name="oauth2relay1333562416"></iframe>

<!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://sourceforge.net/apps/piwik/chibios/" : "http://sourceforge.net/apps/piwik/chibios/");
document.write(unescape("%3Cscript src='/scripts/piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/piwik.js" type="text/javascript"></script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://sourceforge.net/apps/piwik/chibios/piwik.php?idsite=1" style="border:0" alt=""/></p></noscript>
<!-- End Piwik Tag -->

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-19330378-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<div class="no"><img src="Counting%20Semaphores,%20Binary%20Semaphores%20and%20Mutexes%20explained%20%5BChibiOS_RT%20free%20embedded%20RTOS%5D_files/indexer.gif" alt="" width="1" height="1"></div>


</body></html>